<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="Code war of Angel">
<meta property="og:url" content="https://angelteng.github.io/blog/page/2/index.html">
<meta property="og:site_name" content="Code war of Angel">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Code war of Angel">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://angelteng.github.io/blog/page/2/">





  <title>Code war of Angel</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Code war of Angel</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://angelteng.github.io/blog/blog/2019/03/01/flask-uwsgi-nginx-websocket部署实战/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Angel Teng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://upload-images.jianshu.io/upload_images/14827444-0de2e63e8fdaf1bd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code war of Angel">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/03/01/flask-uwsgi-nginx-websocket部署实战/" itemprop="url">nginx+gunicorn+flask-sockerio docker部署实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-01T16:49:35+08:00">
                2019-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>部署方案：flask+uwsgi服务部署一个容器（服务使用flask-socketio实现websocket)、nginx部署一个容器</p>
<h2 id="如何配置："><a href="#如何配置：" class="headerlink" title="如何配置："></a>如何配置：</h2><h3 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.local.com;</span><br><span class="line">    error_log /apps/logs/error_nginx.log ;</span><br><span class="line">    access_log /apps/logs/access_log.log ;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        include proxy_params;</span><br><span class="line">        ;;; 如果include proxy_params 没找到 替换成</span><br><span class="line">        ; proxy_set_header Host $http_host;</span><br><span class="line">        ; proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        ; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        ; proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line"></span><br><span class="line">        proxy_pass http://host_ip:8002;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /socket.io &#123;</span><br><span class="line">        include proxy_params;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_buffering off;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection &quot;Upgrade&quot;;</span><br><span class="line">        proxy_pass http://host_ip:8002/socket.io;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：host_ip为宿主机ip</p>
<h3 id="uwsgi"><a href="#uwsgi" class="headerlink" title="uwsgi"></a>uwsgi</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line"># uwsgi 启动时所使用的地址与端口</span><br><span class="line">http-socket = :8001</span><br><span class="line"></span><br><span class="line">master = true</span><br><span class="line">;lazy-apps = true</span><br><span class="line"># 指向网站目录</span><br><span class="line">chdir = /app</span><br><span class="line"></span><br><span class="line"># python 启动程序文件</span><br><span class="line">wsgi-file = uwsgi_entry.py</span><br><span class="line"># python 程序内用以启动的 application 变量名</span><br><span class="line">callable = app</span><br><span class="line"></span><br><span class="line"># 处理器数</span><br><span class="line">processes = 8</span><br><span class="line">;listen = 1024</span><br><span class="line">gevent = 100</span><br><span class="line">http-websockets = true</span><br></pre></td></tr></table></figure>
<h3 id="uwsgi-entry-py"><a href="#uwsgi-entry-py" class="headerlink" title="uwsgi_entry.py"></a>uwsgi_entry.py</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from config import app_config</span><br><span class="line">from app import create_app</span><br><span class="line">from flask_socketio import SocketIO</span><br><span class="line">from app.services.message_push import MessagePush</span><br><span class="line"></span><br><span class="line">app = create_app(app_config)</span><br><span class="line"># 初始化socket 注意async_mode</span><br><span class="line">socketio = SocketIO(app, async_mode=&quot;threading&quot;)</span><br><span class="line"># nameSpace以类形式初始化</span><br><span class="line">MessagePushHelper = MessagePush(&apos;/test&apos;)</span><br><span class="line">socketio.on_namespace(MessagePushHelper)</span><br><span class="line"></span><br><span class="line"># 实际nginx转发的端口是socket运行的端口 注意host配置0.0.0.0</span><br><span class="line">socketio.run(app, host=&quot;0.0.0.0&quot;, port=8002, use_reloader=False)</span><br></pre></td></tr></table></figure>
<h3 id="后续改用gunicorn"><a href="#后续改用gunicorn" class="headerlink" title="后续改用gunicorn"></a>后续改用gunicorn</h3><p>后面发现这个方案其实只是利用uwsgi起了个嵌入式服务器，所有请求根本没有经过uwsgi服务器。<br>后面看官方文档，改成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line"># uwsgi 启动时所使用的地址与端口</span><br><span class="line">http-socket = :8001</span><br><span class="line"></span><br><span class="line">master = true</span><br><span class="line">;lazy-apps = true</span><br><span class="line"># 指向网站目录</span><br><span class="line">chdir = /app</span><br><span class="line"></span><br><span class="line"># python 启动程序文件</span><br><span class="line">wsgi-file = uwsgi_entry.py</span><br><span class="line"># python 程序内用以启动的 application 变量名</span><br><span class="line">callable = app</span><br><span class="line"></span><br><span class="line"># 处理器数</span><br><span class="line">processes = 1</span><br><span class="line">;listen = 1024</span><br><span class="line">gevent = 100</span><br><span class="line">http-websockets = true </span><br><span class="line"></span><br><span class="line">........</span><br><span class="line">uwsgi_entry.py</span><br><span class="line"></span><br><span class="line">from config import app_config</span><br><span class="line">from app import create_app</span><br><span class="line">from flask_socketio import SocketIO</span><br><span class="line">from app.services.message_push import MessagePush</span><br><span class="line"></span><br><span class="line"># 初始化socket 注意async_mode</span><br><span class="line">socketio = SocketIO()</span><br><span class="line">app = create_app(app_config,socketio)</span><br><span class="line"># nameSpace以类形式初始化</span><br><span class="line">MessagePushHelper = MessagePush(&apos;/test&apos;)</span><br><span class="line">socketio.on_namespace(MessagePushHelper)</span><br><span class="line"></span><br><span class="line">.....</span><br><span class="line">def create_app(app,socketio):</span><br><span class="line">....</span><br><span class="line">socketio.init_app(app, message_queue=&apos;redis://&apos;+ config.HOST_IP) #mutil thread</span><br><span class="line">return app</span><br></pre></td></tr></table></figure></p>
<p>测试发现，还是有间隔400出现，前端不断的connect,disconnect<br>尝试n个方法无果，改用gunicorn服务器<br>gunicorn配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">    #  -*- coding: utf-8 -*-</span><br><span class="line">    # 预加载资源</span><br><span class="line">    preload_app = True</span><br><span class="line">    # 绑定</span><br><span class="line">    bind = &quot;0.0.0.0:8002&quot;</span><br><span class="line">    # 进程数</span><br><span class="line">    workers = 1</span><br><span class="line">    # 线程数</span><br><span class="line">    threads = 10</span><br><span class="line">    # 等待队列最大长度,超过这个长度的链接将被拒绝连接</span><br><span class="line">    backlog = 100</span><br><span class="line">    # 工作模式</span><br><span class="line">    # worker_class = &quot;egg:meinheld#gunicorn_worker&quot;</span><br><span class="line">    worker_class = &quot;geventwebsocket.gunicorn.workers.GeventWebSocketWorker&quot;</span><br><span class="line">    # 最大客户客户端并发数量,对使用线程和协程的worker的工作有影响</span><br><span class="line">    worker_connections = 100</span><br><span class="line">``` </span><br><span class="line">因为websocket需要粘性会话，所以worker只能设为1</span><br><span class="line">[gunicorn不同woker type](https://medium.com/@genchilu/淺談-gunicorn-各個-worker-type-適合的情境-490b20707f28)</span><br><span class="line">其余代码跟上面一样，目前测试稳定。</span><br><span class="line"></span><br><span class="line">## 如何访问</span><br><span class="line">1. 容器间通讯，目前通过docker run -p 3306:3306 暴露端口给宿主机，容器内部服务访问通过 宿主机ip+暴露的端口进行访问，[其他方法](https://birdben.github.io/2017/05/02/Docker/Docker实战（二十七）Docker容器之间的通信/)</span><br><span class="line">2. mysql 持久化：通过 -v /home/data/mysql_data/:/var/lib/mysql/ 保存数据文件 默认路径可以查看 /etc/my.cnf里的datadir配置</span><br><span class="line">3. 由于uwsgi_entry.py 直接运行了 socketio.run命令，实际上所有的服务是通过这个命令的端口访问的，-p暴露的也是这里的端口</span><br><span class="line">4. uwsgi_docker.ini 要配置http-socket模式</span><br><span class="line"></span><br><span class="line">## 问题与方案</span><br><span class="line">1. 逻辑在子线程进行websocket的emit时，参考flask-socketio的文档：</span><br></pre></td></tr></table></figure></p>
<pre><code>In all the examples shown until this point the server responds to an event sent by the client. But for some applications, the server needs to be the originator of a message. This can be useful to send notifications to clients of events that originated in the server, for example in a background thread. The socketio.send() and socketio.emit() methods can be used to broadcast to all connected clients:

def some_function():
    socketio.emit(&apos;some event&apos;, {&apos;data&apos;: 42})

Note that socketio.send() and socketio.emit() are not the same functions as the context-aware send() and emit(). Also note that in the above usage there is no client context, so broadcast=True is assumed and does not need to be specified.
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">注意需要使用 socketio.emit方法，默认是广播的。</span><br><span class="line">socketio 是flask-socketio初始化的实际，注意初始化时配置 async_mode=&quot;threading&quot; 参数，否则emit不成功</span><br></pre></td></tr></table></figure>
<pre><code>async_mode – The asynchronous model to use. See the Deployment section in the documentation for a description of the available options. Valid async modes are threading, eventlet, gevent and gevent_uwsgi. If this argument is not given, eventlet is tried first, then gevent_uwsgi, then gevent, and finally threading. The first async mode that has all its dependencies installed is then one that is chosen

有效的异步模式参数是 threading, eventlet, gevent, gevent_uwsgi。
</code></pre><p><code>`</code></p>
<ol start="2">
<li><p>时区： 在docker run 时增加参数 -v /etc/localtime:/etc/localtime<br><a href="https://brickyang.github.io/2017/03/16/Docker%20中如何设置%20container%20的时区/" target="_blank" rel="noopener">其他方法</a></p>
</li>
<li><p>async_mode=eventlet 有问题，<a href="https://stackoverflow.com/questions/34581255/python-flask-socketio-send-message-from-thread-not-always-working" target="_blank" rel="noopener">see this</a></p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://angelteng.github.io/blog/blog/2019/01/30/docker中pip-install-opencv-python失败/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Angel Teng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://upload-images.jianshu.io/upload_images/14827444-0de2e63e8fdaf1bd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code war of Angel">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/01/30/docker中pip-install-opencv-python失败/" itemprop="url">docker部署uwsgi+flask问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-30T11:04:47+08:00">
                2019-01-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>问题：<br>docker中pip install opencv-python失败.</p>
<p>dockerFile中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">From Alpine</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">RUN pip3 install opencv-python</span><br></pre></td></tr></table></figure></p>
<p>docker build 时出现报错，即使升级了pip之后:<br>Could not find a version that satisfies the requirement opencv-python (from version: )<br>No matching distribution found for opencv-python</p>
<p>原因：<br><a href="https://stackoverflow.com/questions/50950588/trouble-installing-opencv-in-docker-container-using-pip" target="_blank" rel="noopener">from stackoverflow</a><br>I’ve just run into this issue as well. It turns out that this is not working because opencv-python does not have any prebuilt wheels for Alpine (the distribution you’re using as your base docker image).</p>
<p>The conversation in this issue on the opencv-python package explains why this happens in greater detail. The TL;DR is: if you really need to use Alpine, you can try forcing the installation of the manylinux wheel for opencv-python, but this can break. Your best option if you need to keep Alpine is to build the module from source. Since you are running this on OpenFAAS, I suspect you will want to keep your size low, so building from source may be a good option for you.</p>
<p>If you’re not attached to Alpine, I would suggest moving to a different base docker image. If you’re not sure which image to use as your base, I would recommend python:3.7-slim, since it will come with Python already installed (substitute 3.7 for whichever version you are using, but really. . . 3.7 is nice). With this container, you can simply run pip install opencv-python numpy scipy to have all three of your desired packages installed. The rest of your Dockerfile should work mostly unmodified; you will just need to install/uninstall curl using apt instead of apk.</p>
<p>简单来说就是，Alpine中没有prebuild opencv-python,如果一定要用Alpine，可以强制下载编译，但是有可能出错。也可以更换使用 python:3.x-slim镜像。<br>最后Dockerfile:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.5.6-slim-stretch</span><br><span class="line">WORKDIR /app</span><br><span class="line">ADD ....</span><br><span class="line"></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends apt-utils &amp;&amp; \</span><br><span class="line">apt-get install -y \</span><br><span class="line">        libc6-dev \</span><br><span class="line">        gcc \</span><br><span class="line">        mime-support vim libtiff5 libglib2.0-0 libsm6 libxext6 libxrender1 libxext-dev libpcre3 libpcre3-dev &amp;&amp; \</span><br><span class="line">pip3 install --no-cache-dir uWSGI \</span><br><span class="line">    &amp;&amp; apt-get remove -y \</span><br><span class="line">        gcc \</span><br><span class="line">        libc6-dev \</span><br><span class="line">    &amp;&amp; rm -rf /var/lib/apt/lists/* &amp;&amp; \</span><br><span class="line">pip3 install setuptools==39.1.0 &amp;&amp; \ </span><br><span class="line">pip3 install -r requirements.txt </span><br><span class="line"></span><br><span class="line">ENV LD_LIBRARY_PATH=/app/project/services/libs</span><br><span class="line">ENV PYTHONPATH=/app/project/services/libs</span><br><span class="line"></span><br><span class="line">CMD [&quot;uwsgi&quot;, &quot;--ini&quot;, &quot;uwsgi_docker.ini&quot;]</span><br></pre></td></tr></table></figure></p>
<p>在部署docker过程中会遇到：<br><img src="https://upload-images.jianshu.io/upload_images/14827444-c750540543c5fc4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="error"><br>此时需要删掉uwsgi的配置 plugin=python<br>最后uwsgi.ini配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">socket = 0.0.0.0:5051</span><br><span class="line">chdir = /app</span><br><span class="line">wsgi-file = /app/app.py</span><br><span class="line">callable = app</span><br><span class="line">processes = 4</span><br><span class="line">threads = 2</span><br></pre></td></tr></table></figure></p>
<p>nginx配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    charset utf-8;</span><br><span class="line">    client_max_body_size 128M;</span><br><span class="line"></span><br><span class="line">    listen 80;</span><br><span class="line"></span><br><span class="line">    server_name xxx.local.com;</span><br><span class="line">    root        /vagrant/xxx;</span><br><span class="line">    index       index.py;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        include         uwsgi_params;</span><br><span class="line">        uwsgi_pass      127.0.0.1:5051;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://angelteng.github.io/blog/blog/2019/01/29/Nginx通讯机制/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Angel Teng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://upload-images.jianshu.io/upload_images/14827444-0de2e63e8fdaf1bd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code war of Angel">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/01/29/Nginx通讯机制/" itemprop="url">Nginx通讯机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-29T10:24:13+08:00">
                2019-01-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="PHP-FPM与Nginx通讯机制"><a href="#PHP-FPM与Nginx通讯机制" class="headerlink" title="PHP-FPM与Nginx通讯机制"></a>PHP-FPM与Nginx通讯机制</h1><h2 id="CGI协议"><a href="#CGI协议" class="headerlink" title="CGI协议"></a>CGI协议</h2><ol>
<li>通用网关接口（Common Gateway Interface/CGI），CGI描述了服务器和请求处理程序之间传输数据的一种标准。</li>
<li>Common：比如Java的Servlet，Python的WSGI，理论上来说，所有支持标准输出，支持获取环境变量的编程语言都能用来编写CGI程序。</li>
<li>Gateway：“协议翻译机”，通常与网关输入输出两端通信使用的是不同的协议。即一方是HTTP协议，另一方可能是其他协议，比如企业内部的自定义协议。CGI程序既是如此。</li>
<li>Interface：CGI其实是构架在HTTP协议之上的。它描述的是另一个维度的共识标准。<br><img src="https://upload-images.jianshu.io/upload_images/14827444-f0701b0970040921.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="CGI协议"></li>
</ol>
<h2 id="FastCGI"><a href="#FastCGI" class="headerlink" title="FastCGI"></a>FastCGI</h2><p>由于 CGI 的机制是每处理一个请求需要 fork 一个 CGI 进程，请求结束再kill掉这个进程，在实际应用上比较浪费资源，于是就出现了CGI 的改良版本 FastCGI，FastCGI 在请求处理完后，不会 kill 掉进程，而是继续处理多个请求，这样就大大提高了效率。</p>
<h2 id="PHP-FPM"><a href="#PHP-FPM" class="headerlink" title="PHP-FPM"></a>PHP-FPM</h2><p>PHP-FPM 即 PHP-FastCGI Process Manager， 它是 FastCGI 的实现，并提供了进程管理的功能。进程包含 master 进程和 worker 进程两种；master 进程只有一个，负责监听端口，接收来自服务器的请求，而 worker 进程则一般有多个（具体数量根据实际需要进行配置），每个进程内部都会嵌入一个 PHP 解释器，是代码真正执行的地方。<br><img src="https://upload-images.jianshu.io/upload_images/14827444-13be702b80b58d3f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="PHP-FPM"></p>
<p><a href="https://segmentfault.com/a/1190000018048956" target="_blank" rel="noopener">参考</a></p>
<h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><p><img src="https://upload-images.jianshu.io/upload_images/3240886-313fd9b1018241f3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/682" alt="uwsgi"></p>
<ol>
<li>WSGI: 它是用在 python web 框架编写的应用程序与web服务器之间的规范。它使得Web App可以与Web Server顺利通信。所有使用 WSGI 的服务器都可以运行使用 WSGI 规范的web 框架。它规定WSGI application应该实现为一个可调用对象。</li>
<li>uWSGI: uWSGI: 是一个Web服务器，它实现了WSGI协议、uwsgi、http等协议。用于接收前端服务器转发的动态请求并处理后发给 web 应用程序。</li>
<li>uwsgi: uwsgi是uWSGI服务器实现的独有的协议。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://angelteng.github.io/blog/blog/2019/01/22/HTTP中的链接/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Angel Teng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://upload-images.jianshu.io/upload_images/14827444-0de2e63e8fdaf1bd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code war of Angel">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/01/22/HTTP中的链接/" itemprop="url">HTTP中的"链接"</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-22T11:05:32+08:00">
                2019-01-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/浏览器/" itemprop="url" rel="index">
                    <span itemprop="name">浏览器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="短链接"><a href="#短链接" class="headerlink" title="短链接"></a>短链接</h1><p>在HTTP/1.0中，默认使用的是短连接。也就是说，浏览器和服务器每进行一次HTTP操作，就建立一次连接，但任务结束就中断连接。如果客户端浏览器访问的某个HTML或其他类型的 Web页中包含有其他的Web资源，如JavaScript文件、图像文件、CSS文件等；当浏览器每遇到这样一个Web资源，就会建立一个HTTP会话。</p>
<h1 id="长链接"><a href="#长链接" class="headerlink" title="长链接"></a>长链接</h1><p>HTTP/1.1起，默认使用长连接，用以保持连接特性。使用长连接的HTTP协议，会在响应头有加入这行代码：Connection:keep-alive<br>在使用长连接的情况下，当一个网页打开完成后，客户端和服务器之间用于传输HTTP数据的 TCP连接不会关闭，如果客户端再次访问这个服务器上的网页，会继续使用这一条已经建立的连接。Keep-Alive不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如Apache）中设定这个时间。实现长连接要客户端和服务端都支持长连接。<br>HTTP协议的长连接和短连接，实质上是TCP协议的长连接和短连接。</p>
<h1 id="Websocket"><a href="#Websocket" class="headerlink" title="Websocket"></a>Websocket</h1><p>WebSocket是一种在单个TCP连接上进行全双工通信的协议。<br>网站为了实现推送技术，所用的技术都是轮询。轮询是在特定的的时间间隔（如每1秒），由浏览器对服务器发出HTTP请求，然后由服务器返回最新的数据给客户端的浏览器。这种传统的模式带来很明显的缺点，即浏览器需要不断的向服务器发出请求，然而HTTP请求可能包含较长的头部，其中真正有效的数据可能只是很小的一部分，显然这样会浪费很多的带宽等资源。<br>而比较新的技术去做轮询的效果是Comet。这种技术虽然可以双向通信，但依然需要反复发出请求。而且在Comet中，普遍采用的长链接，也会消耗服务器资源。<br>在这种情况下，HTML5定义了WebSocket协议，能更好的节省服务器资源和带宽，并且能够更实时地进行通讯。<br>Websocket使用ws或wss的统一资源标志符，类似于HTTPS，其中wss表示在TLS之上的Websocket。</p>
<h1 id="HTTP2"><a href="#HTTP2" class="headerlink" title="HTTP2"></a>HTTP2</h1><p><a href="https://zh.wikipedia.org/wiki/HTTP/2" target="_blank" rel="noopener">wiki</a></p>
<ol>
<li>新的二进制格式：HTTP1.x的解析是基于文本，HTTP2.0的协议解析决定采用二进制格式</li>
<li>多路复用<br>￼<img src="https://upload-images.jianshu.io/upload_images/14827444-ad2e8696df76a798.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="多路复用"></li>
<li>header压缩</li>
<li>服务端推送</li>
<li>HTTP2.0其实可以支持非HTTPS的，但是现在主流的浏览器像chrome，firefox表示还是只支持基于 TLS 部署的HTTP2.0协议，所以要想升级成HTTP2.0还是先升级HTTPS为好</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://angelteng.github.io/blog/blog/2019/01/18/机器学习基石学习笔记（三）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Angel Teng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://upload-images.jianshu.io/upload_images/14827444-0de2e63e8fdaf1bd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code war of Angel">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/01/18/机器学习基石学习笔记（三）/" itemprop="url">机器学习基石学习笔记（三）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-18T11:10:18+08:00">
                2019-01-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/机器学习/" itemprop="url" rel="index">
                    <span itemprop="name">机器学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://angelteng.github.io/blog/blog/2019/01/14/机器学习基石学习笔记（二）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Angel Teng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://upload-images.jianshu.io/upload_images/14827444-0de2e63e8fdaf1bd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code war of Angel">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/01/14/机器学习基石学习笔记（二）/" itemprop="url">机器学习基石学习笔记（二）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-14T10:48:57+08:00">
                2019-01-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/机器学习/" itemprop="url" rel="index">
                    <span itemprop="name">机器学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Why-can-machines-learn"><a href="#Why-can-machines-learn" class="headerlink" title="Why can machines learn?"></a>Why can machines learn?</h1><h2 id="No-Free-Lunch定理"><a href="#No-Free-Lunch定理" class="headerlink" title="No Free Lunch定理"></a>No Free Lunch定理</h2><p>No Free Lunch定理表明，没有一个学习算法可以在任何领域总是产生最准确的学习器。不管采用何种学习算法，至少存在一个目标函数，能够使得随机猜测算法是更好的算法。<br>NFL说明了无法保证一个机器学习算法在D以外的数据集上一定能分类或预测正确，除非加上一些假设条件。</p>
<h2 id="机器学习中假设与目标函数相等的可能性"><a href="#机器学习中假设与目标函数相等的可能性" class="headerlink" title="机器学习中假设与目标函数相等的可能性"></a>机器学习中假设与目标函数相等的可能性</h2><ol>
<li>机器学习中hypothesis与目标函数相等的可能性，类比于罐子中橙色球的概率问题；罐子里的一颗颗弹珠类比于机器学习样本空间的x；橙色的弹珠类比于h(x)与f不相等；绿色的弹珠类比于h(x)与f相等；从罐子中抽取的N个球类比于机器学习的训练样本D，且这两种抽样的样本与总体样本之间都是独立同分布的。所以呢，如果样本N够大，且是独立同分布的，那么，从样本中h(x)!=f(x)的概率就能推导在抽样样本外的所有样本中h(x)!=f(x)的概率是多少。</li>
<li>$E_{in}(h)$表示在抽样样本中，h(x)与$y_n$不相等的概率；$E_{out}(h)$表示实际所有样本中，h(x)与f(x)不相等的概率是多少。如果$E_{in}$很小，那么他们错误概率满足PAC，他们很接近。</li>
<li>M是hypothesis的个数，N是样本D的数量，ϵ是参数。该union bound表明，当M有限，且N足够大的时候，Bad Data出现的概率就更低了，即能保证D对于所有的h都有$E_{in}~~E_{out}$，满足PAC，演算法A的选择不受限制。那么满足这种union bound的情况，我们就可以和之前一样，选取一个合理的演算法（PLA/pocket），选择使$E_{in}$最小的$h_m$作为矩g，一般能够保证$g≈f$，即有不错的泛化能力。<br>所以，如果hypothesis的个数M是有限的，N足够大，那么通过演算法A任意选择一个矩g，都有$E_{in}≈E_{out}$成立；同时，如果找到一个矩g，使<br>$E_{in}≈0$，PAC就能保证$E_{out}≈0$。至此，就证明了机器学习是可行的。<br><img src="https://upload-images.jianshu.io/upload_images/14827444-03c02ac56816b05a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="PAC"><br><img src="https://upload-images.jianshu.io/upload_images/14827444-177cb242b589f03d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="learning possible"></li>
</ol>
<h2 id="M对机器学习可行性的影响"><a href="#M对机器学习可行性的影响" class="headerlink" title="M对机器学习可行性的影响"></a>M对机器学习可行性的影响</h2><ol>
<li>从之前课程可以归纳出机器学习可行需要满足：<ul>
<li>$E_{in}(g)≈E_{out}(g)$</li>
<li>$E_{in}(g)$ 足够小</li>
</ul>
</li>
<li>hypothesis set的个数M是有限的，但是当M很小时，不一定找到满足（2）的M，当M很大时，同样由霍夫丁不等式，$E_{in}(g)$与$E_{out}(g)$可能相差很大</li>
<li>shatter : $m_H(H) = 2^N$ 即，exists N input can be shatter.也就是说对于inputs的所有情况都能列举出来。例如对N个输入，如果能够将$2^N$种情况都列出来，则称该N个输入能够被假设集H shatter。</li>
<li>二分类（dichotomy)，dichotomy就是将空间中的点（例如二维平面）用一条直线分成正类（蓝色o）和负类（红色x），它的上界是$2^N$。</li>
<li>成长函数（growth function），记为$m_H(H)$，成长函数的定义是：对于由N个点组成的不同集合中，某集合对应的dichotomy最大，那么这个dichotomy值就$m_H(H)$，它的上界是$2^N$。</li>
<li>break point，满足$m_H(H)=2^K$的k的最小值就是break point。那么令有k个点，如果k大于等于break point时，它的成长函数一定小于2的k次方。</li>
<li>Vapnik-Chervonenkis(VC) bound<br><img src="https://upload-images.jianshu.io/upload_images/14827444-d5a5c4fe93c88a7d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Vapnik-Chervonenkis(VC) bound"></li>
</ol>
<h2 id="VC-Dimension"><a href="#VC-Dimension" class="headerlink" title="VC Dimension"></a>VC Dimension</h2><ol>
<li>假设空间H有break point k，那么它的成长函数是有界的，它的上界称为Bound function。根据数学归纳法，Bound function也是有界的，且上界为$N^{k-1}$<br><img src="https://upload-images.jianshu.io/upload_images/14827444-4f6401c360c8cc34.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>那么 vc bound可以转化为<br><img src="https://upload-images.jianshu.io/upload_images/14827444-80d8e08338621ae5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="vc bound"><br>这个式子的值只与k、N有关。</li>
<li>VC Dimension：就是某假设集H能够shatter的最多inputs的个数，即最大完全正确的分类能力（注意，只要存在一种分布的inputs能够正确分类也满足）。根据之前break point的定义：假设集不能被shatter任何分布类型的inputs的最少个数。则VC Dimension等于break point的个数减一。即：<br>$$ d_{vc} = ‘min k’-1 $$</li>
<li>$ d_{vc} = d+1$</li>
<li>VC Dimension代表了假设空间的分类能力，即反映了H的自由度，产生dichotomy的数量，也就等于features的个数，但也不是绝对的。</li>
<li>将$d_{vc}$代表k，此时vc bound 为<br><img src="https://upload-images.jianshu.io/upload_images/14827444-accd66b08778439d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="vc bound"><br><img src="https://upload-images.jianshu.io/upload_images/14827444-d3da3e84b07ac608.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ϵ的值"><br>ϵ表现了假设空间H的泛化能力，ϵ越小，泛化能力越大。<br>那么，可以得到<br><img src="https://upload-images.jianshu.io/upload_images/14827444-e80ffd85385d0e95.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ein"><br>上述不等式的右边第二项称为模型复杂度，其模型复杂度与样本数量N、假设空间$H(d_{vc})$、ϵ有关。$E_{out}$由$E_{in}$共同决定。下面绘出$E_{out}$、model complexity、$E_{in}$随$d_{vc}$变化的关系：<br><img src="https://upload-images.jianshu.io/upload_images/14827444-58c067ed436601e8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="eout"></li>
<li>样本复杂度（Sample Complexity），如果选定$d_{vc}$，样本D的数量N大约是$d_{vc}$的10000倍。这个数值太大了，实际中往往不需要这么多的样本数量，大概只需要$d_{vc}$的10倍就够了。</li>
</ol>
<h2 id="Noise-and-Error"><a href="#Noise-and-Error" class="headerlink" title="Noise and Error"></a>Noise and Error</h2><h3 id="错误衡量"><a href="#错误衡量" class="headerlink" title="错误衡量"></a>错误衡量</h3><p><img src="https://upload-images.jianshu.io/upload_images/14827444-475ff99ec11870e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Noise"></p>
<ol>
<li><p>错误衡量三个特性</p>
<ul>
<li>out-of-sample：样本外的未知数据</li>
<li>pointwise：对每个数据点x进行测试</li>
<li>classification：看prediction与target是否一致，classification error通常称为0/1 error</li>
</ul>
</li>
<li><p>PointWise error实际上就是对数据集的每个点计算错误并计算平均<br><img src="https://upload-images.jianshu.io/upload_images/14827444-8dd269939c49fec9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="PointWise"><br>pointwise error一般可以分成两类：0/1 error和squared error。<br><img src="https://upload-images.jianshu.io/upload_images/14827444-48a29866a612b03c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="PointWise"></p>
</li>
<li>Ideal Mini-Target由P(y∣x)和err共同决定。<br>0/1 error中的mini-target是取P(y|x)最大的那个类，而squared error中的mini-target是取所有类的加权平方和。<br><img src="https://upload-images.jianshu.io/upload_images/14827444-40449f24bc45f4bd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Ideal"></li>
</ol>
<h3 id="Algorithmic-Error-Measure"><a href="#Algorithmic-Error-Measure" class="headerlink" title="Algorithmic Error Measure"></a>Algorithmic Error Measure</h3><ol>
<li>Error有两种：false accept和false reject。false accept意思是误把负类当成正类，false reject是误把正类当成负类。</li>
<li>机器学习演算法A的cost function error估计有多种方法，真实的err一般难以计算，常用的方法可以采用plausible或者friendly<br><img src="https://upload-images.jianshu.io/upload_images/14827444-e806b8c8d89313a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="err"></li>
</ol>
<h3 id="Weighted-Classification"><a href="#Weighted-Classification" class="headerlink" title="Weighted Classification"></a>Weighted Classification</h3><p>机器学习的Cost Function即来自于这些error，也就是算法里面的迭代的目标函数，通过优化使得Error（Ein）不断变小。<br>cost function中，false accept和false reject赋予不同的权重，在演算法中体现。对不同权重的错误惩罚，可以选用virtual copying的方法。<br><img src="https://upload-images.jianshu.io/upload_images/14827444-c6eafcced58adb88.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Weighted Classification"></p>
<p><a href="https://blog.csdn.net/zyghs/article/details/78762070" target="_blank" rel="noopener">hw</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://angelteng.github.io/blog/blog/2019/01/10/机器学习基石学习笔记（一）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Angel Teng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://upload-images.jianshu.io/upload_images/14827444-0de2e63e8fdaf1bd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code war of Angel">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/01/10/机器学习基石学习笔记（一）/" itemprop="url">机器学习基石学习笔记（一）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-10T16:45:16+08:00">
                2019-01-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/机器学习/" itemprop="url" rel="index">
                    <span itemprop="name">机器学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="When-can-machines-learn"><a href="#When-can-machines-learn" class="headerlink" title="When can machines learn?"></a>When can machines learn?</h1><h2 id="机器学习应用的三个条件："><a href="#机器学习应用的三个条件：" class="headerlink" title="机器学习应用的三个条件："></a>机器学习应用的三个条件：</h2><pre><code>- 事物本身存在某种潜在规律
- 某些问题难以使用普通编程解决
- 有大量的数据样本可供使用
</code></pre><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><pre><code>![流程](https://i.loli.net/2018/07/24/5b55fd7c69d0c.png)
</code></pre><p>术语：</p>
<ul>
<li>输入x</li>
<li>输出y</li>
<li>目标函数f，即最接近实际样本分布的规律</li>
<li>训练样本data</li>
<li>假设hypothesis，一个机器学习模型对应了很多不同的hypothesis，通过演算法A，选择一个最佳的hypothesis对应的函数称为矩g，g能最好地表示事物的内在规律，也是我们最终想要得到的模型表达式。</li>
</ul>
<h2 id="感知机（Perceptron）"><a href="#感知机（Perceptron）" class="headerlink" title="感知机（Perceptron）"></a>感知机（Perceptron）</h2><p>$$ h(x) = sign ((\sum_{i=1}^n w_i x_i) - threshold)$$<br>其中 h(x) = 1/ -1, w是权重，threshold是阙值<br>把$threshold = w_0x_0 (x_0 =1)$,得到<br>$$ h(x) = sign ((\sum_{i=1}^n w_i x_i) - w_0x_0) $$<br>$$      = sign(\sum_{i=0}^n w_i x_i)$$<br>$$      = sign(W^TX) $$<br>假设只有二维，那么$ h(x) = w_0 + w_1x_1 + w_2x_2$，其中$w_0 + w_1x_1 + w_2x_2=0$是其中一条分类直线，权重w不同，代表不同的直线。<br><img src="https://upload-images.jianshu.io/upload_images/14827444-da05a80b15f9f791.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="感知机"></p>
<h3 id="线性感知机-Perceptron-Learning-Algorithm-PLA"><a href="#线性感知机-Perceptron-Learning-Algorithm-PLA" class="headerlink" title="线性感知机 Perceptron Learning Algorithm(PLA)"></a>线性感知机 Perceptron Learning Algorithm(PLA)</h3><ul>
<li>逐步修正：首先在平面上随意取一条直线，看看哪些点分类错误。然后开始对第一个错误点就行修正，即变换直线的位置，使这个错误点变成分类正确的点。接着，再对第二个、第三个等所有的错误分类点就行直线纠正，直到所有的点都完全分类正确了，就得到了最好的直线。</li>
<li><p>做法：首先随机选择一条直线进行分类。然后找到第一个分类错误的点，如果这个点表示正类，被误分为负类，即$w_t ^t x_n(t)&lt;0$，那表示w和x夹角大于90度，其中w是直线的法向量(垂直于这条直线）（ps:直线方程式的系数代表该直线的法向量）。所以，x被误分在直线的下侧（相对于法向量，法向量的方向即为正类所在的一侧），修正的方法就是使w和x夹角小于90度。通常做法是$w←w+yx, y=1$，如图右上角所示，一次或多次更新后的w+yx与x夹角小于90度，能保证x位于直线的上侧，则对误分为负类的错误点完成了直线修正。<br><img src="https://upload-images.jianshu.io/upload_images/14827444-6df1ace7b37904ac.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="修正"><br><img src="https://upload-images.jianshu.io/upload_images/14827444-555ef5e069e554ca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="修正"></p>
</li>
<li><p>保证数据是线性可分：假设有这样一条直线，能够将正类和负类完全分开，令这时候的目标权重为$w_f$,对于每一个点，满足$y_n = sign(w_f^t x_n)$， 那么即每一个到这条直线的距离都大于0，即对于每一个点t，满足：<br>$$ y_{n(t)} w_n^f x_{n(t)} &gt;= min y_{n} w_n^f x_{n} &gt; 0 $$</p>
</li>
<li><p>PLA会对每次错误的点进行修正，更新权重$w_{t+1}$的值，如果$w_{t+1}与w_f$越来越接近，数学运算上就是内积越大，那表示证明PLA是有学习效果<br>的。<br>推导：<br>$$ w_f^T w_{t+1} = w_f^T(w_t + y_nx_n^t) $$<br>$$               = w_f^Tw_t + w_f^Ty_nx_n^t $$<br>$$               &gt; w_f^Tw_t + 0 $$<br>$$               &gt; w_f^Tw_t $$</p>
</li>
<li><p>为了证明内积的增长不是由于长度而是夹角，推导：<br>当有错误的点的时候，即$ y_{n(t)} w_n^f x_{n(t)} &lt;= 0 $<br>那么<br>$$ ||w_{t+1}||^2 = || w_t + y_{n(t)}x_{n(t)}||^2 $$<br>$$               = || w_t||^2 + 2w_ty_{n(t)}x_{n(t)} + ||y_{n(t)}x_{n(t)}||^2 $$<br>$$               &lt;= || w_t||^2 + 0 + ||y_{n(t)}x_{n(t)}||^2  (y_n = 1/-1)$$<br>$$               &lt;= || w_t||^2 + ||maxx_{n(t)}||^2 $$<br>所以 $||w_{t+1}||^2$的增长量不会超过$||maxx_{n(t)}||^2$ </p>
</li>
<li>如果$w_0 = 0$, 经过T次修正后，得 $ w_f^T \over ||wf||$$ w_T \over ||w_T||$$ &gt;= \sqrt{T}*constant$<br>推导：<img src="https://upload-images.jianshu.io/upload_images/14827444-4ff721dcc695769c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br><img src="https://upload-images.jianshu.io/upload_images/14827444-4e8339fd939091ca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>因​$\sqrt{T}⋅constant≤1$，也就是说，迭代次数T是有上界的。</li>
</ul>
<h2 id="口袋算法-Packet-Algorithm"><a href="#口袋算法-Packet-Algorithm" class="headerlink" title="口袋算法 Packet Algorithm"></a>口袋算法 Packet Algorithm</h2><p>对于非线性可分的PLA，容忍有错误点，取错误点的个数最少时的权重w。</p>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><pre><code>1. 按输出y的分类
    - 监督学习
    - 非监督学习
    - 半监督学习
    - 增强学习(Reniforcement Learning): 我们给模型或系统一些输入，但是给不了我们希望的真实的输出y，根据模型的输出反馈，如果反馈结果良好，更接近真实输出，就给其正向激励，如果反馈结果不好，偏离真实输出，就给其反向激励。不断通过“反馈-修正”这种形式，一步一步让模型学习的更好。
![分类](https://upload-images.jianshu.io/upload_images/14827444-76aec3f8c180d9b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

2. 按Data分类
    - Batch Learning: 一次性拿到整个Data，对其进行学习建模。
    - Online: 在线学习模型，数据是实时更新的，根据数据一个个进来，同步更新我们的算法。
        PLA算法。
        增强学习。
    - Active Learning: 让机器具备主动问问题的能力，例如手写数字识别，机器自己生成一个数字或者对它不确定的手写字主动提问。
![按协议分类](https://upload-images.jianshu.io/upload_images/14827444-d75fbba06061b513.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


3. 按输入X的类型
    - concrete features：具体的特征。
    - raw features：比如说手写数字识别中每个数字所在图片的mxn维像素值；比如语音信号的频谱。
    - abstract features：比如某购物网站做购买预测时，提供给参赛者的是抽象加密过的资料编号或者ID。
![输入X的类型](https://upload-images.jianshu.io/upload_images/14827444-f5218d30d2eafcfc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
</code></pre><h2 id="Python实现PLA"><a href="#Python实现PLA" class="headerlink" title="Python实现PLA"></a>Python实现PLA</h2><p><a href="https://huangweiran.club/2018/01/27/PLA和pocket算法：简单Python实现/index.html" target="_blank" rel="noopener">参考</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">def new_PLA(mat):</span><br><span class="line">    &apos;&apos;&apos; </span><br><span class="line">    rewrite the naive PLA algorithm using vectorazation.</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    m,n = mat.shape</span><br><span class="line">    w = zeros(n)</span><br><span class="line">    bias = ones(m)</span><br><span class="line">    x_vec = c_[bias, mat] # add x0=1</span><br><span class="line">    update_cnt = 0</span><br><span class="line">    prepos = -1 # the previous position</span><br><span class="line"></span><br><span class="line">    while True:</span><br><span class="line">        out = sign(x_vec[:,0:-1] @ w)</span><br><span class="line">        out[out == 0] = -1 # sign(0) = -1 here</span><br><span class="line"></span><br><span class="line">        false_ind = where(out != sign(x_vec[:,-1]))[0] # indices where PLA is false</span><br><span class="line">        if not false_ind.any():</span><br><span class="line">            break # no false points</span><br><span class="line">        if not false_ind[false_ind &gt; prepos].any():</span><br><span class="line">            prepos = -1</span><br><span class="line"></span><br><span class="line">        pos = false_ind[false_ind &gt; prepos][0]</span><br><span class="line">        w += x_vec[pos, -1] * x_vec[pos, 0:-1] # updating the weight</span><br><span class="line">        prepos = pos</span><br><span class="line">        update_cnt += 1</span><br><span class="line"></span><br><span class="line">    return w, update_cnt</span><br><span class="line"></span><br><span class="line">data = loadtxt(r&apos;/vagrant/train.dat.txt&apos;)</span><br><span class="line">w1, iteration1 = new_PLA(data)</span><br><span class="line">print(w1,&apos;\n&apos;, iteration1)</span><br></pre></td></tr></table></figure>
<h2 id="Python实现Pocket算法"><a href="#Python实现Pocket算法" class="headerlink" title="Python实现Pocket算法"></a>Python实现Pocket算法</h2><p><a href="https://huangweiran.club/2018/01/27/PLA和pocket算法：简单Python实现/index.html" target="_blank" rel="noopener">参考</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">def pocket(mat, iter_num = 50):</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    pocket algorithm implement.</span><br><span class="line">    what is different from PLA is that pocket pick a random point each time</span><br><span class="line">    and update if the new point causes less mistakes</span><br><span class="line">    &apos;&apos;&apos;</span><br><span class="line">    m,n = mat.shape</span><br><span class="line">    w = zeros(n)</span><br><span class="line">    bias = ones(m)</span><br><span class="line">    x_vec = c_[bias,mat] # add the bias term</span><br><span class="line"></span><br><span class="line">    out = sign(x_vec[:,0:-1] @ w)</span><br><span class="line">    out[out == 0 ] = -1 # for sign(0) = -1 here</span><br><span class="line">    pre_error = sum((out - x_vec[:,-1]) != 0) # calculate the error</span><br><span class="line"></span><br><span class="line">    for i in range(iter_num):</span><br><span class="line">        false_id = where(out != x_vec[:,-1])[0] # the indices of mistakes</span><br><span class="line">        if not false_id.any():</span><br><span class="line">            break</span><br><span class="line">        rand_id = false_id[random.randint(len(false_id))] # randomly pick one false point</span><br><span class="line">        w += x_vec[rand_id,-1] * x_vec[rand_id,0:-1] # updating the weight</span><br><span class="line">        out = sign(x_vec[:,0:-1] @ w)</span><br><span class="line">        out[out == 0] = -1</span><br><span class="line">        new_error = sum((out - x_vec[:,-1]) != 0)</span><br><span class="line">        if new_error &lt; pre_error:</span><br><span class="line">            w_pocket = w.copy() # w_pocket&apos;s base should not be w</span><br><span class="line">            pre_error = new_error</span><br><span class="line"></span><br><span class="line">    return w_pocket</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://angelteng.github.io/blog/blog/2019/01/10/Python-PIL-docker-环境部署问题/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Angel Teng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://upload-images.jianshu.io/upload_images/14827444-0de2e63e8fdaf1bd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code war of Angel">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/01/10/Python-PIL-docker-环境部署问题/" itemprop="url">Python PIL docker 环境部署问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-10T11:02:58+08:00">
                2019-01-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>Python3中需要pip install Pillow</li>
<li>docker 部署中 dockerfile 文件需要添加<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RUN apk add --no-cache libjpeg-turbo</span><br><span class="line">RUN apk add --no-cache --virtual ... jpeg-dev zlib-dev ...</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如果不add jped-dev 在docker build 时会报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">Running setup.py install for Pillow: started</span><br><span class="line">Running setup.py install for Pillow: finished with status &apos;error&apos;</span><br><span class="line">Complete output from command /usr/bin/python3.6 -u -c &quot;import setuptools, tokenize;__file__=&apos;/tmp/pip-build-x49fkhbc/Pillow/setup.py&apos;;f=getattr(tokenize, &apos;open&apos;, open)(__file__);code=f.read().replace(&apos;\r\n&apos;, &apos;\n&apos;);f.close();exec(compile(code, __file__, &apos;exec&apos;))&quot; install --record /tmp/pip-98mau5hk-record/install-record.txt --single-version-externally-managed --compile:</span><br><span class="line">running install</span><br><span class="line">running build</span><br><span class="line">running build_py</span><br><span class="line">creating build</span><br><span class="line">creating build/lib.linux-x86_64-3.6</span><br><span class="line">creating build/lib.linux-x86_64-3.6/PIL</span><br><span class="line">....</span><br><span class="line">running egg_info</span><br><span class="line">writing src/Pillow.egg-info/PKG-INFO</span><br><span class="line">writing dependency_links to src/Pillow.egg-info/dependency_links.txt</span><br><span class="line">writing top-level names to src/Pillow.egg-info/top_level.txt</span><br><span class="line">reading manifest file &apos;src/Pillow.egg-info/SOURCES.txt&apos;</span><br><span class="line">reading manifest template &apos;MANIFEST.in&apos;</span><br><span class="line">warning: no files found matching &apos;*.c&apos;</span><br><span class="line">warning: no files found matching &apos;*.h&apos;</span><br><span class="line">warning: no files found matching &apos;*.sh&apos;</span><br><span class="line">no previously-included directories found matching &apos;docs/_static&apos;</span><br><span class="line">warning: no previously-included files found matching &apos;.appveyor.yml&apos;</span><br><span class="line">warning: no previously-included files found matching &apos;.coveragerc&apos;</span><br><span class="line">warning: no previously-included files found matching &apos;.codecov.yml&apos;</span><br><span class="line">warning: no previously-included files found matching &apos;.editorconfig&apos;</span><br><span class="line">warning: no previously-included files found matching &apos;.landscape.yaml&apos;</span><br><span class="line">warning: no previously-included files found matching &apos;.readthedocs.yml&apos;</span><br><span class="line">warning: no previously-included files found matching &apos;.travis&apos;</span><br><span class="line">warning: no previously-included files found matching &apos;.travis/*&apos;</span><br><span class="line">warning: no previously-included files found matching &apos;tox.ini&apos;</span><br><span class="line">warning: no previously-included files matching &apos;.git*&apos; found anywhere in distribution</span><br><span class="line">warning: no previously-included files matching &apos;*.pyc&apos; found anywhere in distribution</span><br><span class="line">warning: no previously-included files matching &apos;*.so&apos; found anywhere in distribution</span><br><span class="line">writing manifest file &apos;src/Pillow.egg-info/SOURCES.txt&apos;</span><br><span class="line">running build_ext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">The headers or library files could not be found for jpeg,</span><br><span class="line">a required dependency when compiling Pillow from source.</span><br><span class="line"></span><br><span class="line">Please see the install instructions at:</span><br><span class="line">   https://pillow.readthedocs.io/en/latest/installation.html</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/tmp/pip-build-x49fkhbc/Pillow/setup.py&quot;, line 800, in &lt;module&gt;</span><br><span class="line">    zip_safe=not (debug_build() or PLATFORM_MINGW), )</span><br><span class="line">  File &quot;/usr/lib/python3.6/site-packages/setuptools/__init__.py&quot;, line 129, in setup</span><br><span class="line">    return distutils.core.setup(**attrs)</span><br><span class="line">  File &quot;/usr/lib/python3.6/distutils/core.py&quot;, line 148, in setup</span><br><span class="line">    dist.run_commands()</span><br><span class="line">  File &quot;/usr/lib/python3.6/distutils/dist.py&quot;, line 955, in run_commands</span><br><span class="line">    self.run_command(cmd)</span><br><span class="line">  File &quot;/usr/lib/python3.6/distutils/dist.py&quot;, line 974, in run_command</span><br><span class="line">    cmd_obj.run()</span><br><span class="line">  File &quot;/usr/lib/python3.6/site-packages/setuptools/command/install.py&quot;, line 61, in run</span><br><span class="line">    return orig.install.run(self)</span><br><span class="line">  File &quot;/usr/lib/python3.6/distutils/command/install.py&quot;, line 545, in run</span><br><span class="line">    self.run_command(&apos;build&apos;)</span><br><span class="line">  File &quot;/usr/lib/python3.6/distutils/cmd.py&quot;, line 313, in run_command</span><br><span class="line">    self.distribution.run_command(command)</span><br><span class="line">  File &quot;/usr/lib/python3.6/distutils/dist.py&quot;, line 974, in run_command</span><br><span class="line">    cmd_obj.run()</span><br><span class="line">  File &quot;/usr/lib/python3.6/distutils/command/build.py&quot;, line 135, in run</span><br><span class="line">    self.run_command(cmd_name)</span><br><span class="line">  File &quot;/usr/lib/python3.6/distutils/cmd.py&quot;, line 313, in run_command</span><br><span class="line">    self.distribution.run_command(command)</span><br><span class="line">  File &quot;/usr/lib/python3.6/distutils/dist.py&quot;, line 974, in run_command</span><br><span class="line">    cmd_obj.run()</span><br><span class="line">  File &quot;/usr/lib/python3.6/distutils/command/build_ext.py&quot;, line 339, in run</span><br><span class="line">    self.build_extensions()</span><br><span class="line">  File &quot;/tmp/pip-build-x49fkhbc/Pillow/setup.py&quot;, line 612, in build_extensions</span><br><span class="line">    raise RequiredDependencyException(f)</span><br><span class="line">__main__.RequiredDependencyException: jpeg</span><br><span class="line"></span><br><span class="line">During handling of the above exception, another exception occurred:</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">  File &quot;/tmp/pip-build-x49fkhbc/Pillow/setup.py&quot;, line 812, in &lt;module&gt;</span><br><span class="line">    raise RequiredDependencyException(msg)</span><br><span class="line">__main__.RequiredDependencyException:</span><br><span class="line"></span><br><span class="line">The headers or library files could not be found for jpeg,</span><br><span class="line">a required dependency when compiling Pillow from source.</span><br><span class="line"></span><br><span class="line">Please see the install instructions at:</span><br><span class="line">   https://pillow.readthedocs.io/en/latest/installation.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------</span><br><span class="line">Command &quot;/usr/bin/python3.6 -u -c &quot;import setuptools, tokenize;__file__=&apos;/tmp/pip-build-x49fkhbc/Pillow/setup.py&apos;;f=getattr(tokenize, &apos;open&apos;, open)(__file__);code=f.read().replace(&apos;\r\n&apos;, &apos;\n&apos;);f.close();exec(compile(code, __file__, &apos;exec&apos;))&quot; install --record /tmp/pip-98mau5hk-record/install-record.txt --single-version-externally-managed --compile&quot; failed with error code 1 in /tmp/pip-build-x49fkhbc/Pillow/</span><br></pre></td></tr></table></figure></p>
<p>成功打包后，如果不add libgjpeg-turbo<br>会在import PIL时报错<br><a href="https://forums.fast.ai/t/solved-importerror-libjpeg-so-8-cannot-open-shared-object-file-on-wsl/8303" target="_blank" rel="noopener">for detail to check this</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libjpeg.so.8: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://angelteng.github.io/blog/blog/2019/01/10/Python灰度图转伪彩色图/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Angel Teng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://upload-images.jianshu.io/upload_images/14827444-0de2e63e8fdaf1bd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code war of Angel">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/01/10/Python灰度图转伪彩色图/" itemprop="url">Python灰度图转伪彩色图</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-10T10:02:47+08:00">
                2019-01-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>因项目中算法给出分割图是灰度图，而前端需要展示彩色图，搜了下网上资料，参考了opencv写的<a href="http://blog.sina.com.cn/s/blog_8924265b0101ext1.html" target="_blank" rel="noopener">这篇</a>，改成了Python代码<br>效果：<br>原灰度图<br><img src="https://upload-images.jianshu.io/upload_images/14827444-b83e1508197f3373.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="灰度图"><br>伪彩色图<br><img src="https://upload-images.jianshu.io/upload_images/14827444-74c7a847851bcac8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="彩色图"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">from PIL import Image</span><br><span class="line">import requests</span><br><span class="line">from io import BytesIO</span><br><span class="line">import numpy as np</span><br><span class="line">def grayImageTrans(url):</span><br><span class="line">    # url</span><br><span class="line">    # 如果是本地图片</span><br><span class="line">    # img = Image.open(&apos;/tmp/test.jpg&apos;)</span><br><span class="line">    file = requests.get(url)</span><br><span class="line">    tmpIm = BytesIO(file.content)</span><br><span class="line">    img = Image.open(tmpIm)</span><br><span class="line">    # 图片转矩阵</span><br><span class="line">    img = np.array(img)</span><br><span class="line">    # nparray转list</span><br><span class="line">    imgAry = img.tolist()</span><br><span class="line">    tmp=0</span><br><span class="line">    # 加颜色</span><br><span class="line">    for x in range(img.shape[0]):</span><br><span class="line">        for y in range(img.shape[1]):</span><br><span class="line">            tmp = imgAry[x][y]</span><br><span class="line">            imgAry[x][y] = __grayColorTrans(tmp)</span><br><span class="line">    newImgAry = np.array(imgAry)</span><br><span class="line">    # 矩阵转图片</span><br><span class="line">    newImg = Image.fromarray(np.uint8(newImgAry))</span><br><span class="line">    # newImg.save(&apos;/vagrant/test.png&apos;)</span><br><span class="line">    # 转base64</span><br><span class="line">    output_buffer = BytesIO()</span><br><span class="line">    newImg.save(output_buffer, format=&apos;PNG&apos;)</span><br><span class="line">    byte_data = output_buffer.getvalue()</span><br><span class="line">    base64_str = base64.b64encode(byte_data)</span><br><span class="line">    return base64_str</span><br></pre></td></tr></table></figure>
<p>参考：<br>关于Image与Base64转换可以看<a href="https://www.jianshu.com/p/2ff8e6f98257" target="_blank" rel="noopener">这里</a><br><a href="https://my.oschina.net/112612/blog/1594140" target="_blank" rel="noopener">Image图像的convert</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://angelteng.github.io/blog/blog/2019/01/03/Three三维世界初体验/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Angel Teng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://upload-images.jianshu.io/upload_images/14827444-0de2e63e8fdaf1bd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Code war of Angel">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2019/01/03/Three三维世界初体验/" itemprop="url">Three三维世界初体验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-03T15:26:03+08:00">
                2019-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/前端/" itemprop="url" rel="index">
                    <span itemprop="name">前端</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>教程：<br><a href="http://www.hewebgl.com/article/articledir/1" target="_blank" rel="noopener">WebGL中文网教程</a><br><a href="https://threejs.org/docs/index.html#manual/en/introduction/Creating-a-scene" target="_blank" rel="noopener">three文档</a><br><a href="https://blog.csdn.net/linolzhang/article/details/67119049" target="_blank" rel="noopener">碰撞检测</a><br>原理：<br>以物体的中心为起点，向各个顶点（vertices）发出射线，如果射线与其它的物体相交，则检查最近的一个交点与射线起点间的距离，如果这个距离比射线起点至物体顶点间的距离要小，则说明发生了碰撞。但是，当物体的中心在另一个物体内部时，是不能够检测到碰撞的。而且当两个物体能够互相穿过，且有较大部分重合时，检测效果也不理想。 </p>
<p><img src="https://upload-images.jianshu.io/upload_images/14827444-3b266c643b2f3f13.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="代码示例"><br><img src="https://upload-images.jianshu.io/upload_images/14827444-99942b6d2eb3e777.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="碰撞实例"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line">// 初始化Three</span><br><span class="line">var renderer;</span><br><span class="line">function initThree() &#123;</span><br><span class="line">    renderer = new THREE.WebGLRenderer();</span><br><span class="line"></span><br><span class="line">    renderer.setSize(window.innerWidth, window.innerHeight);</span><br><span class="line"></span><br><span class="line">    width = document.getElementById(&apos;canvas-frame&apos;).clientWidth;</span><br><span class="line">    height = document.getElementById(&apos;canvas-frame&apos;).clientHeight;</span><br><span class="line">    renderer = new THREE.WebGLRenderer(&#123;</span><br><span class="line">        antialias : true</span><br><span class="line">    &#125;);</span><br><span class="line">    renderer.setSize(width, height);</span><br><span class="line">    document.getElementById(&apos;canvas-frame&apos;).appendChild(renderer.domElement);</span><br><span class="line">    renderer.setClearColor(0xffffff, 1.0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化Camera</span><br><span class="line">var camera;</span><br><span class="line">function initCamera() &#123;</span><br><span class="line">    // 设置透视相机</span><br><span class="line">    camera = new THREE.PerspectiveCamera(45, width / height, 1, 10000);</span><br><span class="line">    // 设置相机位置</span><br><span class="line">    camera.position.x = 200;</span><br><span class="line">    camera.position.y = 500;</span><br><span class="line">    camera.position.z = 800;</span><br><span class="line">    // 设置相机哪里为上</span><br><span class="line">    // camera.up.x = 0;</span><br><span class="line">    // camera.up.y = 0;</span><br><span class="line">    // camera.up.z = 1;</span><br><span class="line">    // 设置相机看向哪</span><br><span class="line">    camera.lookAt(new THREE.Vector3(0, 0, 0));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化场景</span><br><span class="line">var scene;</span><br><span class="line">function initScene() &#123;</span><br><span class="line">    scene = new THREE.Scene();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化灯光</span><br><span class="line">var light;</span><br><span class="line">function initLight() &#123;</span><br><span class="line">    light = new THREE.DirectionalLight(0xFF0000,1);</span><br><span class="line">    light.position.set(100,100,1);</span><br><span class="line">    scene.add(light);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化里面的元素</span><br><span class="line">var cube;</span><br><span class="line">var mesh;</span><br><span class="line">function initObject() &#123;</span><br><span class="line">    for(var k =0;k&lt;2;k++)&#123;</span><br><span class="line">        // 一个几何体</span><br><span class="line">        var geometry = new THREE.BoxGeometry( 100,100,100);</span><br><span class="line">        // 不同面设置不同颜色</span><br><span class="line">        for ( var i = 0; i &lt; geometry.faces.length; i += 2 ) &#123;</span><br><span class="line"></span><br><span class="line">            var hex = Math.random() * 0xffffff;</span><br><span class="line">            geometry.faces[ i ].color.setHex( hex );</span><br><span class="line">            geometry.faces[ i + 1 ].color.setHex( hex );</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        // 设置纹理</span><br><span class="line">        // var material = new THREE.MeshBasicMaterial( &#123; vertexColors: THREE.FaceColors&#125; );</span><br><span class="line">        var material = new THREE.MeshLambertMaterial( &#123; color: Math.random() * 0xffffff &#125; )</span><br><span class="line">        // 把几何体跟纹理混合起来</span><br><span class="line">        mesh = new THREE.Mesh( geometry,material);</span><br><span class="line">        // 元素的位置</span><br><span class="line">        mesh.position.set(0,k*50,k * 400);</span><br><span class="line">        // 把元素加到场景里</span><br><span class="line">        scene.add(mesh);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 渲染</span><br><span class="line">var stats;</span><br><span class="line">function render()</span><br><span class="line">&#123;</span><br><span class="line">    // renderer.clear();</span><br><span class="line">    // mesh.position.x =mesh.position.x +1;</span><br><span class="line">    renderer.render(scene, camera);</span><br><span class="line">    requestAnimationFrame(render);</span><br><span class="line">    stats.update();</span><br><span class="line">    // TWEEN.update();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 性能检测</span><br><span class="line">function initStats()&#123;</span><br><span class="line">    stats = new Stats();</span><br><span class="line">    stats.setMode(1); // 0: fps, 1: ms</span><br><span class="line">// 将stats的界面对应左上角</span><br><span class="line">    stats.domElement.style.position = &apos;absolute&apos;;</span><br><span class="line">    stats.domElement.style.left = &apos;0px&apos;;</span><br><span class="line">    stats.domElement.style.top = &apos;0px&apos;;</span><br><span class="line">    document.body.appendChild( stats.domElement );</span><br><span class="line">    setInterval( function () &#123;</span><br><span class="line">        stats.begin();</span><br><span class="line">        // 你的每一帧的代码</span><br><span class="line">        stats.end();</span><br><span class="line">    &#125;, 1000 / 60 );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化网格</span><br><span class="line">function initGrid()&#123;</span><br><span class="line">    // 网格的边长是1000，每个小网格的边长是50</span><br><span class="line">    var helper = new THREE.GridHelper( 1000, 50,0x0000ff, 0x808080 );</span><br><span class="line">    var helper2 = new THREE.GridHelper( 1000, 50,0x0000ff, 0x808080 );</span><br><span class="line">    helper2.rotation.x = Math.PI/2;</span><br><span class="line">    scene.add( helper );</span><br><span class="line">    scene.add(helper2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化事件</span><br><span class="line">var INTERSECTED;</span><br><span class="line">function initEvent()&#123;</span><br><span class="line">    var objects=[];</span><br><span class="line">    var raycaster = new THREE.Raycaster();</span><br><span class="line">    var mouse = new THREE.Vector2();</span><br><span class="line">    //监听全局点击事件,通过ray检测选中哪一个object</span><br><span class="line">    document.addEventListener(&quot;mousedown&quot;, (event) =&gt; &#123;</span><br><span class="line">        console.log(&apos;mousedown&apos;);</span><br><span class="line">        event.preventDefault();</span><br><span class="line">        mouse.x = (event.clientX / this.renderer.domElement.clientWidth) * 2 - 1;</span><br><span class="line">        mouse.y = - (event.clientY / this.renderer.domElement.clientHeight) * 2 + 1;</span><br><span class="line"></span><br><span class="line">        raycaster.setFromCamera(mouse, this.camera);</span><br><span class="line">        this.scene.children.forEach(child =&gt; &#123;</span><br><span class="line">            if (child instanceof THREE.Mesh) &#123;//根据需求判断哪些加入objects,也可以在生成object的时候push进objects</span><br><span class="line">                objects.push(child)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        var intersects = raycaster.intersectObjects(objects);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if (intersects.length &gt; 0) &#123;</span><br><span class="line">            if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );</span><br><span class="line"></span><br><span class="line">            INTERSECTED = intersects[ 0 ].object;</span><br><span class="line">            INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();</span><br><span class="line">            INTERSECTED.material.emissive.setHex( 0x0000ff );</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            if ( INTERSECTED ) &#123;</span><br><span class="line">                INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );</span><br><span class="line">                // 碰撞检测</span><br><span class="line">                var originPoint = INTERSECTED.position.clone();</span><br><span class="line">                var crash = false;</span><br><span class="line">                for (var vertexIndex = 0; vertexIndex &lt; INTERSECTED.geometry.vertices.length; vertexIndex++) &#123;</span><br><span class="line">                    // 顶点原始坐标</span><br><span class="line">                    var localVertex = INTERSECTED.geometry.vertices[vertexIndex].clone();</span><br><span class="line">                    // 顶点经过变换后的坐标</span><br><span class="line">                    var globalVertex = localVertex.applyMatrix4(INTERSECTED.matrix);</span><br><span class="line">                    // 获得由中心指向顶点的向量</span><br><span class="line">                    var directionVector = globalVertex.sub(INTERSECTED.position);</span><br><span class="line"></span><br><span class="line">                    // 将方向向量初始化</span><br><span class="line">                    var ray = new THREE.Raycaster(originPoint, directionVector.clone().normalize());</span><br><span class="line">                    // 检测射线与多个物体的相交情况</span><br><span class="line"></span><br><span class="line">                    var collisionResults = ray.intersectObjects(objects);</span><br><span class="line">                    // 如果返回结果不为空，且交点与射线起点的距离小于物体中心至顶点的距离，则发生了碰撞</span><br><span class="line">                    if (collisionResults.length &gt; 0 &amp;&amp; collisionResults[0].distance &lt; directionVector.length()) &#123;</span><br><span class="line">                        crash = true;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if(crash)&#123;</span><br><span class="line">                    alert(&apos;crash&apos;);</span><br><span class="line">                    INTERSECTED.position.set(0,0,400);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            INTERSECTED = null;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, false);</span><br><span class="line"></span><br><span class="line">    document.addEventListener(&quot;mousemove&quot;,(event) =&gt; &#123;</span><br><span class="line">        event.preventDefault();</span><br><span class="line">        if(INTERSECTED)&#123;</span><br><span class="line">            </span><br><span class="line">            var mouse = new THREE.Vector2();</span><br><span class="line">            console.log(( event.clientX / window.innerWidth ) * 2 - 1, - ( event.clientY / window.innerHeight ) * 2 + 1 );</span><br><span class="line">            mouse.set( ( event.clientX / window.innerWidth ) * 2 - 1, - ( event.clientY / window.innerHeight ) * 2 + 1 );</span><br><span class="line"></span><br><span class="line">            raycaster.setFromCamera( mouse, camera );</span><br><span class="line">            var objects = [];</span><br><span class="line">            scene.children.forEach(child =&gt; &#123;</span><br><span class="line">                if (child instanceof THREE.GridHelper) &#123;</span><br><span class="line">                    objects.push(child)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            var intersects = raycaster.intersectObjects( objects );</span><br><span class="line"></span><br><span class="line">            if (intersects.length &gt; 0) &#123;</span><br><span class="line">                var selected = intersects[ 0 ];</span><br><span class="line">                // console.log(selected.point.x,selected.point.y,selected.point.z);</span><br><span class="line">                INTERSECTED.position.copy(selected.point);</span><br><span class="line">                INTERSECTED.position.divideScalar( 50 ).floor().multiplyScalar( 50 ).addScalar( 25 );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,false);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 动画组件</span><br><span class="line">function initTween()&#123;</span><br><span class="line">    new TWEEN.Tween( mesh.position)</span><br><span class="line">        .to( &#123; x: -400,z:100,y:100 &#125;, 3000 ).repeat( Infinity ).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function threeStart() &#123;</span><br><span class="line">    initThree();</span><br><span class="line">    initCamera();</span><br><span class="line">    initScene();</span><br><span class="line">    initLight();</span><br><span class="line">    initObject();</span><br><span class="line">    initGrid();</span><br><span class="line">    initStats();</span><br><span class="line">    initEvent();</span><br><span class="line">    // initTween();</span><br><span class="line">    render();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">threeStart();</span><br></pre></td></tr></table></figure>
<p>拖拽优化：<br>使用three-drag-controller,替代mousemove时间监听<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import DragControls from &apos;three-dragcontrols&apos;;</span><br><span class="line">import OrbitControls from &apos;three-orbitcontrols&apos;;</span><br><span class="line">......</span><br><span class="line">function initDragControls() &#123;</span><br><span class="line">    // 初始化拖拽控件</span><br><span class="line">    var dragControls = new DragControls(meshList, camera, renderer.domElement);</span><br><span class="line">    var controls = new OrbitControls(camera, renderer.domElement);</span><br><span class="line">    </span><br><span class="line">    // 鼠标略过事件</span><br><span class="line">    dragControls.addEventListener(&apos;hoveron&apos;, function (event) &#123;</span><br><span class="line">       </span><br><span class="line">    &#125;);</span><br><span class="line">    // 开始拖拽</span><br><span class="line">    dragControls.addEventListener(&apos;dragstart&apos;, function (event) &#123;</span><br><span class="line">        controls.enabled = false;</span><br><span class="line">    &#125;);</span><br><span class="line">    // 拖拽结束</span><br><span class="line">    dragControls.addEventListener(&apos;dragend&apos;, function (event) &#123;</span><br><span class="line">        controls.enabled = true;</span><br><span class="line">        // crashCheck();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>加入webpack管理，<br>优化后完整代码：<br><img src="https://upload-images.jianshu.io/upload_images/14827444-f9f57f4633d3828f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3d"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><span class="line">var THREE = require(&apos;three&apos;);</span><br><span class="line">import DragControls from &apos;three-dragcontrols&apos;;</span><br><span class="line">import OrbitControls from &apos;three-orbitcontrols&apos;;</span><br><span class="line">import TransformControls from &apos;threejs-transformcontrols&apos;;</span><br><span class="line"></span><br><span class="line">// 初始化Three</span><br><span class="line">var renderer;</span><br><span class="line">var width,height;</span><br><span class="line">function initThree() &#123;</span><br><span class="line">    renderer = new THREE.WebGLRenderer();</span><br><span class="line"></span><br><span class="line">    renderer.setSize(window.innerWidth, window.innerHeight);</span><br><span class="line"></span><br><span class="line">    width = document.getElementById(&apos;canvas-frame&apos;).clientWidth;</span><br><span class="line">    height = document.getElementById(&apos;canvas-frame&apos;).clientHeight;</span><br><span class="line">    renderer = new THREE.WebGLRenderer(&#123;</span><br><span class="line">        antialias : true</span><br><span class="line">    &#125;);</span><br><span class="line">    renderer.setSize(width, height);</span><br><span class="line">    document.getElementById(&apos;canvas-frame&apos;).appendChild(renderer.domElement);</span><br><span class="line">    renderer.setClearColor(0xffffff, 1.0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化Camera</span><br><span class="line">var camera;</span><br><span class="line">function initCamera() &#123;</span><br><span class="line">    // 设置透视相机</span><br><span class="line">    camera = new THREE.PerspectiveCamera(45, width / height, 1, 10000);</span><br><span class="line">    // 设置相机位置</span><br><span class="line">    camera.position.x = 800;</span><br><span class="line">    camera.position.y = 0;</span><br><span class="line">    camera.position.z = 1000;</span><br><span class="line">    // 设置相机哪里为上</span><br><span class="line">    // camera.up.x = 0;</span><br><span class="line">    // camera.up.y = 0;</span><br><span class="line">    // camera.up.z = 1;</span><br><span class="line">    // 设置相机看向哪</span><br><span class="line">    camera.lookAt(new THREE.Vector3(0, 0, 0));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化场景</span><br><span class="line">var scene;</span><br><span class="line">function initScene() &#123;</span><br><span class="line">    scene = new THREE.Scene();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化灯光</span><br><span class="line">var light;</span><br><span class="line">function initLight() &#123;</span><br><span class="line">    light = new THREE.DirectionalLight(0xFF0000,1);</span><br><span class="line">    light.position.set(100,100,1);</span><br><span class="line">    scene.add(light);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化里面的元素</span><br><span class="line">var cube;</span><br><span class="line">var bus;</span><br><span class="line">var meshList = [];</span><br><span class="line">function initObject() &#123;</span><br><span class="line">    for(var k =0;k&lt;2;k++)&#123;</span><br><span class="line">        // 一个几何体</span><br><span class="line">        var geometry = new THREE.BoxGeometry( 100,50,150);</span><br><span class="line">        // 不同面设置不同颜色</span><br><span class="line">        for ( var i = 0; i &lt; geometry.faces.length; i += 2 ) &#123;</span><br><span class="line"></span><br><span class="line">            var hex = Math.random() * 0xffffff;</span><br><span class="line">            geometry.faces[ i ].color.setHex( hex );</span><br><span class="line">            geometry.faces[ i + 1 ].color.setHex( hex );</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        // 设置纹理</span><br><span class="line">        // var material = new THREE.MeshBasicMaterial( &#123; vertexColors: THREE.FaceColors&#125; );</span><br><span class="line">        var material = new THREE.MeshLambertMaterial( &#123; color: Math.random() * 0xffffff &#125; )</span><br><span class="line">        // 把几何体跟纹理混合起来</span><br><span class="line">        var mesh = new THREE.Mesh( geometry,material);</span><br><span class="line">        meshList.push(mesh);</span><br><span class="line">        // 元素的位置</span><br><span class="line">        mesh.position.set(0,k*50,k * 400);</span><br><span class="line">        // 把元素加到场景里</span><br><span class="line">        scene.add(mesh);</span><br><span class="line">    &#125;</span><br><span class="line">    var busGeometry = new THREE.BoxGeometry( 500,500,500);</span><br><span class="line">    var butMaterial = new THREE.MeshLambertMaterial( &#123; color: Math.random() * 0xffffff, transparent: true, opacity: 0.5&#125; );</span><br><span class="line">    bus = new THREE.Mesh(busGeometry,butMaterial);</span><br><span class="line">    bus.position.set(0,0,0);</span><br><span class="line">    scene.add(bus);</span><br><span class="line">    var edges = new THREE.EdgesHelper( bus, 0x1535f7 );//设置边框，可以旋转</span><br><span class="line">    scene.add( edges );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 渲染</span><br><span class="line">var stats;</span><br><span class="line">function render()</span><br><span class="line">&#123;</span><br><span class="line">    // renderer.clear();</span><br><span class="line">    // mesh.position.x =mesh.position.x +1;</span><br><span class="line">    renderer.render(scene, camera);</span><br><span class="line">    requestAnimationFrame(render);</span><br><span class="line">    // stats.update();</span><br><span class="line">    // TWEEN.update();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 性能检测</span><br><span class="line">function initStats()&#123;</span><br><span class="line">    stats = new Stats();</span><br><span class="line">    stats.setMode(1); // 0: fps, 1: ms</span><br><span class="line">// 将stats的界面对应左上角</span><br><span class="line">    stats.domElement.style.position = &apos;absolute&apos;;</span><br><span class="line">    stats.domElement.style.left = &apos;0px&apos;;</span><br><span class="line">    stats.domElement.style.top = &apos;0px&apos;;</span><br><span class="line">    document.body.appendChild( stats.domElement );</span><br><span class="line">    setInterval( function () &#123;</span><br><span class="line">        stats.begin();</span><br><span class="line">        // 你的每一帧的代码</span><br><span class="line">        stats.end();</span><br><span class="line">    &#125;, 1000 / 60 );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化网格</span><br><span class="line">function initGrid()&#123;</span><br><span class="line">    // 网格的边长是1000，每个小网格的边长是50</span><br><span class="line"></span><br><span class="line">    var helper = new THREE.GridHelper( 1000, 50,0x0000ff, 0x808080 );</span><br><span class="line">    var helper2 = new THREE.GridHelper( 1000, 50,0x0000ff, 0x808080 );</span><br><span class="line">    helper2.rotation.x = Math.PI/2;</span><br><span class="line">    scene.add( helper );</span><br><span class="line">    // scene.add(helper2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 初始化事件</span><br><span class="line">var INTERSECTED;</span><br><span class="line">function initEvent()&#123;</span><br><span class="line">    var objects= meshList;</span><br><span class="line">    var raycaster = new THREE.Raycaster();</span><br><span class="line">    var mouse = new THREE.Vector2();</span><br><span class="line">    //监听全局点击事件,通过ray检测选中哪一个object</span><br><span class="line">    // document.addEventListener(&quot;mousedown&quot;, (event) =&gt; &#123;</span><br><span class="line">    //     console.log(&apos;mousedown&apos;);</span><br><span class="line">    //     event.preventDefault();</span><br><span class="line">    //     mouse.x = (event.clientX / this.renderer.domElement.clientWidth) * 2 - 1;</span><br><span class="line">    //     mouse.y = - (event.clientY / this.renderer.domElement.clientHeight) * 2 + 1;</span><br><span class="line">    //</span><br><span class="line">    //     raycaster.setFromCamera(mouse, this.camera);</span><br><span class="line">    //     // this.scene.children.forEach(child =&gt; &#123;</span><br><span class="line">    //     //     if (child instanceof THREE.Mesh) &#123;//根据需求判断哪些加入objects,也可以在生成object的时候push进objects</span><br><span class="line">    //     //         objects.push(child)</span><br><span class="line">    //     //     &#125;</span><br><span class="line">    //     // &#125;)</span><br><span class="line">    //     var intersects = raycaster.intersectObjects(objects);</span><br><span class="line">    //</span><br><span class="line">    //</span><br><span class="line">    //     if (intersects.length &gt; 0) &#123;</span><br><span class="line">    //         if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );</span><br><span class="line">    //</span><br><span class="line">    //         INTERSECTED = intersects[ 0 ].object;</span><br><span class="line">    //         INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();</span><br><span class="line">    //         INTERSECTED.material.emissive.setHex( 0x0000ff );</span><br><span class="line">    //     &#125;</span><br><span class="line">    //     else &#123;</span><br><span class="line">    //         if ( INTERSECTED ) &#123;</span><br><span class="line">    //             INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );</span><br><span class="line">    //             // 碰撞检测</span><br><span class="line">    //             if(crashCheck(objects))&#123;</span><br><span class="line">    //                 alert(&apos;crash&apos;);</span><br><span class="line">    //                 INTERSECTED.position.set(0,0,400);</span><br><span class="line">    //             &#125;</span><br><span class="line">    //         &#125;</span><br><span class="line">    //         INTERSECTED = null;</span><br><span class="line">    //</span><br><span class="line">    //     &#125;</span><br><span class="line">    // &#125;, false);</span><br><span class="line"></span><br><span class="line">    // document.addEventListener(&quot;mousemove&quot;,(event) =&gt; &#123;</span><br><span class="line">    //     event.preventDefault();</span><br><span class="line">    //     if(INTERSECTED)&#123;</span><br><span class="line">    //</span><br><span class="line">    //         var mouse = new THREE.Vector2();</span><br><span class="line">    //         mouse.set( ( event.clientX / window.innerWidth ) * 2 - 1, - ( event.clientY / window.innerHeight ) * 2 + 1 );</span><br><span class="line">    //         // console.log(mouse.x,mouse.y);</span><br><span class="line">    //         var vector = new THREE.Vector3( mouse.x, mouse.y, 0.5 ).unproject( camera );</span><br><span class="line">    //         var raycaster = new THREE.Raycaster(camera.position, vector.sub( camera.position ).normalize());</span><br><span class="line">    //         var objects = [bus];</span><br><span class="line">    //         // scene.children.forEach(child =&gt; &#123;</span><br><span class="line">    //         //     if (child instanceof THREE.GridHelper) &#123;</span><br><span class="line">    //         //         objects.push(child)</span><br><span class="line">    //         //     &#125;</span><br><span class="line">    //         // &#125;);</span><br><span class="line">    //</span><br><span class="line">    //         var intersects = raycaster.intersectObjects( objects );</span><br><span class="line">    //</span><br><span class="line">    //</span><br><span class="line">    //         if (intersects.length &gt; 0) &#123;</span><br><span class="line">    //             var selected = intersects[ 0 ];</span><br><span class="line">    //             console.log(selected.point.x,selected.point.y,selected.point.z,INTERSECTED.position.z);</span><br><span class="line">    //             INTERSECTED.position.set(selected.point.x,selected.point.y,INTERSECTED.position.z);</span><br><span class="line">    //             INTERSECTED.position.divideScalar( 50 ).floor().multiplyScalar( 50 ).addScalar( 25 );</span><br><span class="line">    //</span><br><span class="line">    //         &#125;</span><br><span class="line">    //     &#125;</span><br><span class="line">    // &#125;,false);</span><br><span class="line"></span><br><span class="line">    var an = 1;</span><br><span class="line">    document.getElementById(&apos;J_left&apos;).addEventListener(&apos;click&apos;,function(e)&#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        e.stopPropagation();</span><br><span class="line">        var radius = 1000;</span><br><span class="line">        an = an + 1;</span><br><span class="line">        // console.log(an);</span><br><span class="line">        camera.position.z = radius * Math.cos( (Math.PI / 180 ) * (an) );</span><br><span class="line">        camera.position.x = radius * Math.sin( (Math.PI / 180 ) * (an) );</span><br><span class="line">        camera.lookAt(new THREE.Vector3(0, 0, 0));</span><br><span class="line">        // console.log(&apos;left,x=&apos;+camera.position.x+&apos;,z=&apos;+camera.position.z);</span><br><span class="line">    &#125;);</span><br><span class="line">    document.getElementById(&apos;J_right&apos;).addEventListener(&apos;click&apos;,function(e)&#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        e.stopPropagation();</span><br><span class="line">        var radius = 1000;</span><br><span class="line">        an = an - 1;</span><br><span class="line">        // console.log(an);</span><br><span class="line">        camera.position.z = radius * Math.cos( (Math.PI / 180 ) * (an) );</span><br><span class="line">        camera.position.x = radius * Math.sin( (Math.PI / 180 ) * (an) );</span><br><span class="line">        camera.lookAt(new THREE.Vector3(0, 0, 0));</span><br><span class="line">        // console.log(&apos;left,x=&apos;+camera.position.x+&apos;,z=&apos;+camera.position.z);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function crashCheck(objects)&#123;</span><br><span class="line">    if(INTERSECTED)&#123;</span><br><span class="line">        var originPoint = INTERSECTED.position.clone();</span><br><span class="line">        var crash = false;</span><br><span class="line">        for (var vertexIndex = 0; vertexIndex &lt; INTERSECTED.geometry.vertices.length; vertexIndex++) &#123;</span><br><span class="line">            // 顶点原始坐标</span><br><span class="line">            var localVertex = INTERSECTED.geometry.vertices[vertexIndex].clone();</span><br><span class="line">            // 顶点经过变换后的坐标</span><br><span class="line">            var globalVertex = localVertex.applyMatrix4(INTERSECTED.matrix);</span><br><span class="line">            // 获得由中心指向顶点的向量</span><br><span class="line">            var directionVector = globalVertex.sub(INTERSECTED.position);</span><br><span class="line"></span><br><span class="line">            // 将方向向量初始化</span><br><span class="line">            var ray = new THREE.Raycaster(originPoint, directionVector.clone().normalize());</span><br><span class="line">            // 检测射线与多个物体的相交情况</span><br><span class="line"></span><br><span class="line">            var collisionResults = ray.intersectObjects(objects);</span><br><span class="line">            // 如果返回结果不为空，且交点与射线起点的距离小于物体中心至顶点的距离，则发生了碰撞</span><br><span class="line">            if (collisionResults.length &gt; 0 &amp;&amp; collisionResults[0].distance &lt; directionVector.length()) &#123;</span><br><span class="line">                crash = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if(crash)&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 动画组建</span><br><span class="line">function initTween()&#123;</span><br><span class="line">    new TWEEN.Tween( mesh.position)</span><br><span class="line">        .to( &#123; x: -400,z:100,y:100 &#125;, 3000 ).repeat( Infinity ).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function initDragControls() &#123;</span><br><span class="line">    // 添加平移控件</span><br><span class="line">    // var transformControls = new TransformControls(camera, renderer.domElement);</span><br><span class="line">    // scene.add(transformControls);</span><br><span class="line"></span><br><span class="line">    // 初始化拖拽控件</span><br><span class="line">    var dragControls = new DragControls(meshList, camera, renderer.domElement);</span><br><span class="line">    var controls = new OrbitControls(camera, renderer.domElement);</span><br><span class="line">    </span><br><span class="line">    // 鼠标略过事件</span><br><span class="line">    dragControls.addEventListener(&apos;hoveron&apos;, function (event) &#123;</span><br><span class="line">        // 让变换控件对象和选中的对象绑定</span><br><span class="line">        // transformControls.attach(event.object);</span><br><span class="line">    &#125;);</span><br><span class="line">    // 开始拖拽</span><br><span class="line">    dragControls.addEventListener(&apos;dragstart&apos;, function (event) &#123;</span><br><span class="line">        controls.enabled = false;</span><br><span class="line">    &#125;);</span><br><span class="line">    // 拖拽结束</span><br><span class="line">    dragControls.addEventListener(&apos;dragend&apos;, function (event) &#123;</span><br><span class="line">        controls.enabled = true;</span><br><span class="line">        crashCheck();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function threeStart() &#123;</span><br><span class="line">    initThree();</span><br><span class="line">    initCamera();</span><br><span class="line">    initScene();</span><br><span class="line">    initLight();</span><br><span class="line">    initObject();</span><br><span class="line">    initGrid();</span><br><span class="line">    initDragControls();</span><br><span class="line">    // initStats();</span><br><span class="line">    initEvent();</span><br><span class="line">    // initTween();</span><br><span class="line">    render();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">threeStart();</span><br></pre></td></tr></table></figure>
<p>后期打算添加物理引擎<a href="https://www.jianshu.com/p/716b79ab5cde" target="_blank" rel="noopener">Physijs</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><span class="page-number current">2</span><a class="page-number" href="/blog/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/6/">6</a><a class="extend next" rel="next" href="/blog/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://upload-images.jianshu.io/upload_images/14827444-0de2e63e8fdaf1bd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Angel Teng">
            
              <p class="site-author-name" itemprop="name">Angel Teng</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/blog/archives/">
              
                  <span class="site-state-item-count">52</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/blog/category/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/blog/tags/index.html">
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Angel Teng</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  


  

  

</body>
</html>
